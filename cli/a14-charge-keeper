#!/usr/bin/env bash
set -euo pipefail

readonly VERSION="0.3.0"
BAT_DIR="/sys/class/power_supply"
BAT_NAME="${BAT_NAME:-BAT0}"
END_FILE="$BAT_DIR/$BAT_NAME/charge_control_end_threshold"
START_FILE="$BAT_DIR/$BAT_NAME/charge_control_start_threshold"
SERVICE="a14-charge-keeper.service"
SLEEP_HOOK="/lib/systemd/system-sleep/a14-charge-keeper"
BACKUP_DIR="/var/lib/a14-charge-keeper"
LOCK_FILE="/var/lock/a14-charge-keeper.lock"

usage() {
  cat <<USAGE
A14 Charge Keeper v$VERSION

ì‚¬ìš©ë²•:
  a14-charge-keeper set <20-100>   # ì¢…ë£Œ ì„ê³„ê°’ì„ í¼ì„¼íŠ¸ë¡œ ì„¤ì •(ì˜ˆ: 60)
  a14-charge-keeper status          # í˜„ì¬ ì„ê³„ê°’/ë°°í„°ë¦¬ ìƒíƒœ í‘œì‹œ
  a14-charge-keeper persist <20-100># ë¶€íŒ…/ì ˆì „ ë³µì› ìë™ì ìš© êµ¬ì„±
  a14-charge-keeper clear           # ì„ê³„ê°’ 100%ë¡œ ë³µì› + ìë™ì ìš© í•´ì œ
  a14-charge-keeper uninstall       # ì„¤ì¹˜ë¬¼(ì„œë¹„ìŠ¤/í›…) ì œê±°
  a14-charge-keeper verify <20-100> # ì„¤ì •ê°’ ê²€ì¦ (í…ŒìŠ¤íŠ¸ìš©)
USAGE
}

log_message() {
  local level="$1"
  shift
  echo "[$(date '+%Y-%m-%d %H:%M:%S')] [$level] $*" >&2
}

acquire_lock() {
  if ! mkdir "$LOCK_FILE" 2>/dev/null; then
    log_message "ERROR" "ë‹¤ë¥¸ ì¸ìŠ¤í„´ìŠ¤ê°€ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”."
    exit 4
  fi
  trap 'rm -rf "$LOCK_FILE"' EXIT
}

require_root() {
  if [[ $EUID -ne 0 ]]; then
    log_message "ERROR" "ë£¨íŠ¸ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. 'sudo'ë¡œ ë‹¤ì‹œ ì‹¤í–‰í•˜ì„¸ìš”."
    exit 1
  fi
}

assert_supported() {
  if [[ ! -e "$END_FILE" ]]; then
    log_message "ERROR" "ë°°í„°ë¦¬ ì¶©ì „ ì œì–´ê°€ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤: $END_FILE"
    log_message "INFO" "BAT_NAMEì´ ë‹¤ë¥´ë‹¤ë©´ 'BAT_NAME=BAT1 a14-charge-keeper ...' ì‹ìœ¼ë¡œ ì§€ì •í•˜ì„¸ìš”."
    log_message "INFO" "ë¨¼ì € 'check-support.sh'ë¡œ í•˜ë“œì›¨ì–´ ì§€ì› ì—¬ë¶€ë¥¼ í™•ì¸í•˜ì„¸ìš”."
    exit 2
  fi
  
  if [[ ! -r "$END_FILE" ]]; then
    log_message "ERROR" "ë°°í„°ë¦¬ íŒŒì¼ ì½ê¸° ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤: $END_FILE"
    exit 2
  fi
}

validate_input() {
  local val="$1"
  if ! [[ "$val" =~ ^[0-9]+$ ]]; then
    log_message "ERROR" "ìˆ«ìë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤: $val"
    exit 3
  fi
  
  if (( val < 20 || val > 100 )); then
    log_message "ERROR" "20~100 ì‚¬ì´ì˜ ê°’ë§Œ í—ˆìš©ë©ë‹ˆë‹¤: $val"
    exit 3
  fi
}

backup_current_value() {
  mkdir -p "$BACKUP_DIR"
  local backup_file="$BACKUP_DIR/threshold_backup_$(date +%s)"
  
  if ! cat "$END_FILE" > "$backup_file" 2>/dev/null; then
    log_message "ERROR" "í˜„ì¬ ê°’ ë°±ì—… ì‹¤íŒ¨"
    return 1
  fi
  
  echo "$backup_file"
}

verify_threshold() {
  local expected="$1"
  
  sleep 0.5  # ì»¤ë„ì´ ê°’ì„ ë°˜ì˜í•  ì‹œê°„
  
  local actual
  actual=$(cat "$END_FILE" 2>/dev/null || echo "ERROR")
  
  if [[ "$actual" == "ERROR" ]]; then
    log_message "ERROR" "ì„ê³„ê°’ ì½ê¸° ì‹¤íŒ¨"
    return 1
  fi
  
  if [[ "$actual" == "$expected" ]]; then
    log_message "INFO" "sysfs ì„¤ì • í™•ì¸ë¨: ${expected}%"
    return 0
  else
    log_message "ERROR" "sysfs ê°’ ë¶ˆì¼ì¹˜: ì„¤ì • ${expected}%, ì‹¤ì œ ${actual}%"
    return 1
  fi
}

check_hardware_conflicts() {
  # TLP ì¶©ëŒ í™•ì¸
  if systemctl is-active --quiet tlp 2>/dev/null; then
    log_message "WARN" "TLPê°€ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤. ë°°í„°ë¦¬ ì„¤ì •ì´ ì¶©ëŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
  fi
  
  # asusctl ì¶©ëŒ í™•ì¸
  if command -v asusctl >/dev/null 2>&1; then
    log_message "WARN" "asusctlì´ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì„¤ì •ì´ ì¶©ëŒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
  fi
  
  # ì“°ê¸° ê¶Œí•œ í™•ì¸
  if [[ ! -w "$END_FILE" ]]; then
    log_message "ERROR" "ë°°í„°ë¦¬ íŒŒì¼ ì“°ê¸° ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤: $END_FILE"
    exit 2
  fi
}

safe_set_threshold() {
  local new_value="$1"
  local backup_file
  
  # í•˜ë“œì›¨ì–´ ì¶©ëŒ ê²€ì‚¬
  check_hardware_conflicts
  
  # í˜„ì¬ ê°’ ë°±ì—…
  if ! backup_file=$(backup_current_value); then
    log_message "ERROR" "ë°±ì—… ì‹¤íŒ¨ë¡œ ì¸í•´ ì„¤ì •ì„ ì¤‘ë‹¨í•©ë‹ˆë‹¤."
    return 1
  fi
  
  log_message "INFO" "í˜„ì¬ ê°’ ë°±ì—…ë¨: $backup_file"
  
  # ìƒˆ ê°’ ì„¤ì •
  if ! echo "$new_value" > "$END_FILE" 2>/dev/null; then
    log_message "ERROR" "ì„ê³„ê°’ ì“°ê¸° ì‹¤íŒ¨"
    return 1
  fi
  
  # ê²€ì¦
  if ! verify_threshold "$new_value"; then
    log_message "WARN" "ë¡¤ë°± ì‹œë„ ì¤‘..."
    if [[ -f "$backup_file" ]] && cat "$backup_file" > "$END_FILE" 2>/dev/null; then
      log_message "INFO" "ë¡¤ë°± ì™„ë£Œ"
    else
      log_message "ERROR" "ë¡¤ë°± ì‹¤íŒ¨! ìˆ˜ë™ìœ¼ë¡œ ë³µêµ¬í•´ì•¼ í•©ë‹ˆë‹¤."
    fi
    return 1
  fi
  
  log_message "INFO" "ì„ê³„ê°’ ì„¤ì • ì™„ë£Œ: ${new_value}%"
  return 0
}

set_limit() {
  require_root
  assert_supported
  acquire_lock
  
  local val="$1"
  validate_input "$val"
  
  if ! safe_set_threshold "$val"; then
    log_message "ERROR" "ì„ê³„ê°’ ì„¤ì • ì‹¤íŒ¨"
    exit 5
  fi
  
  echo "[âœ…] charge_control_end_threshold = $val ì ìš© ì™„ë£Œ"
}

show_status() {
  assert_supported
  
  local end_threshold; end_threshold=$(cat "$END_FILE" 2>/dev/null || echo "ì½ê¸° ì‹¤íŒ¨" )
  echo "Device : $BAT_NAME"
  echo "ì¶©ì „ ì¢…ë£Œ: ${end_threshold}%"
  
  # ì¶©ì „ ì‹œì‘ ì„ê³„ê°’ (ì§€ì›í•˜ëŠ” ëª¨ë¸ë§Œ)
  if [[ -e "$START_FILE" ]]; then
    local start_threshold; start_threshold=$(cat "$START_FILE" 2>/dev/null || echo "ì½ê¸° ì‹¤íŒ¨")
    echo "ì¶©ì „ ì‹œì‘: ${start_threshold}% (ThinkPad/Lenovo ë“± ì§€ì›)"
  fi
  
  # ë°±ì—… íŒŒì¼ ì •ë³´
  if [[ -d "$BACKUP_DIR" ]]; then
    local backup_count
    backup_count=$(find "$BACKUP_DIR" -name "threshold_backup_*" 2>/dev/null | wc -l)
    echo "ë°±ì—… íŒŒì¼: ${backup_count}ê°œ"
  fi
  
  # upower ì •ë³´ (ìˆëŠ” ê²½ìš°)
  if command -v upower >/dev/null 2>&1; then
    echo
    upower -i "$(upower -e | grep -E "BAT[0-9]" | head -n1)" 2>/dev/null | sed -n '1,25p' || true
  fi
}

install_persist() {
  local val="$1"
  validate_input "$val"
  
  # ë¨¼ì € ì„ê³„ê°’ ì„¤ì •
  set_limit "$val"
  
  # systemd ì„œë¹„ìŠ¤ ìƒì„± (ê²€ì¦ ë¡œì§ í¬í•¨)
  cat >/etc/systemd/system/$SERVICE <<UNIT
[Unit]
Description=Set ASUS A14 charge threshold at boot
After=multi-user.target

[Service]
Type=oneshot
ExecStart=/bin/bash -c '
  END_FILE="$BAT_DIR/$BAT_NAME/charge_control_end_threshold"
  if [[ -w "\$END_FILE" ]]; then
    echo $val > "\$END_FILE"
    sleep 2
    ACTUAL=\$(cat "\$END_FILE" 2>/dev/null || echo "ERROR")
    if [[ "\$ACTUAL" == "$val" ]]; then
      logger "a14-charge-keeper: ë¶€íŒ… ì‹œ ì„ê³„ê°’ $val% ì„¤ì • ì™„ë£Œ"
    else
      logger "a14-charge-keeper: ë¶€íŒ… ì‹œ ì„ê³„ê°’ ì„¤ì • ì‹¤íŒ¨ (ì˜ˆìƒ: $val%, ì‹¤ì œ: \$ACTUAL%)"
      exit 1
    fi
  else
    logger "a14-charge-keeper: ë°°í„°ë¦¬ ì œì–´ íŒŒì¼ì— ì“°ê¸° ê¶Œí•œ ì—†ìŒ"
    exit 1
  fi
'
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
UNIT

  systemctl daemon-reload
  systemctl enable --now "$SERVICE"
  
  # ì ˆì „ ë³µì› í›…
  cat >"$SLEEP_HOOK" <<HOOK
#!/bin/bash
case "\$1" in
  post|resume|thaw)
    BAT_NAME="\${BAT_NAME:-BAT0}"
    END_FILE="/sys/class/power_supply/\$BAT_NAME/charge_control_end_threshold"
    if [[ -w "\$END_FILE" ]]; then
      echo "$val" > "\$END_FILE" 2>/dev/null && \\
        logger "a14-charge-keeper: ì ˆì „ ë³µì› ì‹œ ë°°í„°ë¦¬ ì œí•œ ${val}% ì ìš© (\$BAT_NAME)"
    fi
  ;;
esac
HOOK
  chmod +x "$SLEEP_HOOK"
  
  echo "[âœ…] ë¶€íŒ…/ì ˆì „ í›„ ìë™ ì¬ì ìš© êµ¬ì„± ì™„ë£Œ (í˜„ì¬ ê°’: $val%)"
}

clear_limit() {
  require_root
  assert_supported
  acquire_lock
  
  if ! safe_set_threshold "100"; then
    log_message "ERROR" "ì„ê³„ê°’ 100% ë³µì› ì‹¤íŒ¨"
    exit 5
  fi
  
  systemctl disable --now "$SERVICE" 2>/dev/null || true
  rm -f "/etc/systemd/system/$SERVICE"
  rm -f "$SLEEP_HOOK"
  systemctl daemon-reload || true
  
  echo "[âœ…] ì„ê³„ê°’ì„ 100%ë¡œ ë³µì›í•˜ê³  ìë™ ì ìš©ì„ í•´ì œí–ˆìŠµë‹ˆë‹¤."
}

uninstall_all() {
  clear_limit
  rm -rf "$BACKUP_DIR"
  rm -f "$0"
  echo "[âœ…] a14-charge-keeperë¥¼ ì™„ì „íˆ ì œê±°í–ˆìŠµë‹ˆë‹¤."
}

verify_command() {
  assert_supported
  local val="$1"
  validate_input "$val"
  
  local actual
  actual=$(cat "$END_FILE" 2>/dev/null || echo "ERROR")
  
  echo "ğŸ” sysfs ê°’ í™•ì¸: ${actual}%"
  
  if [[ "$actual" == "$val" ]]; then
    echo "[âœ…] sysfs ê°’ì´ ì¼ì¹˜í•©ë‹ˆë‹¤"
  else
    echo "[âŒ] sysfs ê°’ì´ ì˜ˆìƒê³¼ ë‹¤ë¦…ë‹ˆë‹¤ (ì˜ˆìƒ: ${val}%)"
    exit 1
  fi
}

# ë©”ì¸ ë¡œì§
cmd="${1:-}"
case "$cmd" in
  set)
    shift; : "${1:?ê°’(20-100)ê°€ í•„ìš”í•©ë‹ˆë‹¤}"; set_limit "$1" ;;
  status)
    show_status ;;
  persist)
    shift; : "${1:?ê°’(20-100)ê°€ í•„ìš”í•©ë‹ˆë‹¤}"; require_root; install_persist "$1" ;;
  clear)
    clear_limit ;;
  uninstall)
    uninstall_all ;;
  verify)
    shift; : "${1:?ê°’(20-100)ê°€ í•„ìš”í•©ë‹ˆë‹¤}"; verify_command "$1" ;;
  -h|--help|help|"")
    usage ;;
  *)
    echo "ì•Œ ìˆ˜ ì—†ëŠ” ëª…ë ¹: $cmd" >&2; usage; exit 64 ;;
esac